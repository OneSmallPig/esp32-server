# å¤©æ°”ç¼“å­˜æ± ï¼ˆå¹»å½±æ± ï¼‰æ€§èƒ½ä¼˜åŒ–æŒ‡å—

## ğŸ“Š å¿…è¦æ€§åˆ†æ

### ç°æœ‰å®ç°çš„æ€§èƒ½é—®é¢˜

| é—®é¢˜ç±»å‹ | æè¿° | å½±å“ |
|---------|-----|------|
| **é‡å¤APIè°ƒç”¨** | æ¯æ¬¡æŸ¥è¯¢éƒ½è°ƒç”¨å’Œé£å¤©æ°”API | å»¶è¿Ÿ2-5ç§’ï¼Œæµªè´¹é…é¢ |
| **ç½‘ç»œçˆ¬è™«å¼€é”€** | æ¯æ¬¡éƒ½çˆ¬å–HTMLé¡µé¢ | ç½‘ç»œå»¶è¿Ÿï¼Œè§£æè€—æ—¶ |
| **APIé™åˆ¶é£é™©** | å…è´¹1000æ¬¡/å¤©é™åˆ¶ | å¤šç”¨æˆ·ç¯å¢ƒæ˜“è¶…é™ |
| **èµ„æºæµªè´¹** | ç›¸åŒæ•°æ®é‡å¤è·å– | æœåŠ¡å™¨è´Ÿè½½é«˜ |

### IoTåœºæ™¯ä¸‹çš„å¿…è¦æ€§

âœ… **é«˜é¢‘æŸ¥è¯¢** - ESP32è®¾å¤‡å¯èƒ½å®šæ—¶æŸ¥è¯¢å¤©æ°”  
âœ… **å¤šè®¾å¤‡å…±äº«** - åŒä¸€åœ°ç‚¹çš„å¤šä¸ªè®¾å¤‡æŸ¥è¯¢ç›¸åŒæ•°æ®  
âœ… **å“åº”é€Ÿåº¦è¦æ±‚** - IoTè®¾å¤‡éœ€è¦å¿«é€Ÿå“åº”  
âœ… **ç½‘ç»œèµ„æºçè´µ** - å‡å°‘ä¸å¿…è¦çš„ç½‘ç»œè°ƒç”¨  

## ğŸš€ æ€§èƒ½æå‡æ•ˆæœ

### å“åº”æ—¶é—´å¯¹æ¯”

| åœºæ™¯ | åŸç‰ˆå¤©æ°”æŸ¥è¯¢ | ç¼“å­˜ç‰ˆæœ¬ï¼ˆå‘½ä¸­ï¼‰ | ç¼“å­˜ç‰ˆæœ¬ï¼ˆæœªå‘½ä¸­ï¼‰ |
|------|-------------|----------------|------------------|
| é¦–æ¬¡æŸ¥è¯¢ | 2-5ç§’ | 2-5ç§’ | 2-5ç§’ |
| é‡å¤æŸ¥è¯¢ | 2-5ç§’ | **0.1-0.3ç§’** | 2-5ç§’ |
| æ‰¹é‡æŸ¥è¯¢åŒåœ°ç‚¹ | 10-25ç§’ | **0.5-1.5ç§’** | 10-25ç§’ |

### APIè°ƒç”¨æ¬¡æ•°

```
åŸç‰ˆå®ç°ï¼š
- æ¯æ¬¡æŸ¥è¯¢ = 1æ¬¡åŸå¸‚API + 1æ¬¡é¡µé¢çˆ¬å–
- 10æ¬¡ç›¸åŒåœ°ç‚¹æŸ¥è¯¢ = 20æ¬¡ç½‘ç»œè¯·æ±‚

ç¼“å­˜ç‰ˆæœ¬ï¼š
- ç¬¬1æ¬¡æŸ¥è¯¢ = 1æ¬¡åŸå¸‚API + 1æ¬¡é¡µé¢çˆ¬å–
- åç»­9æ¬¡æŸ¥è¯¢ = 0æ¬¡ç½‘ç»œè¯·æ±‚
- å‡å°‘APIè°ƒç”¨ï¼š90%ï¼ˆç›¸åŒåœ°ç‚¹ï¼‰
```

### å†…å­˜å ç”¨

```
å•ä¸ªç¼“å­˜æ¡ç›®ï¼šçº¦2-5KB
50ä¸ªåŸå¸‚ç¼“å­˜ï¼šçº¦100-250KB
æ€»ä½“å†…å­˜å¢åŠ ï¼šå¾®ä¸è¶³é“
```

## ğŸ› ï¸ éƒ¨ç½²æŒ‡å—

### 1. æ–‡ä»¶éƒ¨ç½²

```bash
# å¤åˆ¶æ–°æ–‡ä»¶åˆ°å¯¹åº”ä½ç½®
cp core/utils/weather_cache.py main/xiaozhi-server/core/utils/
cp plugins_func/functions/get_weather_cached.py main/xiaozhi-server/plugins_func/functions/
```

### 2. é…ç½®æ›´æ–°

åœ¨ `config.yaml` æˆ– `.config.yaml` ä¸­æ·»åŠ ï¼š

```yaml
plugins:
  # æ–°å¢ç¼“å­˜é…ç½®
  weather_cache:
    weather_cache_ttl: 3600    # å¤©æ°”ç¼“å­˜1å°æ—¶
    city_cache_ttl: 86400      # åŸå¸‚ç¼“å­˜24å°æ—¶
    max_cache_size: 50         # æœ€å¤§50ä¸ªæ¡ç›®
    enable_async_refresh: true # å¯ç”¨å¼‚æ­¥åˆ·æ–°

# æ›´æ–°æ’ä»¶å‡½æ•°åˆ—è¡¨
Intent:
  function_call:
    functions:
      - get_weather_cached  # ä½¿ç”¨ç¼“å­˜ç‰ˆæœ¬
      # å…¶ä»–æ’ä»¶...
```

### 3. é€æ­¥è¿ç§»ç­–ç•¥

#### æ–¹æ¡ˆAï¼šå®Œå…¨æ›¿æ¢ï¼ˆæ¨èï¼‰
```yaml
# ç›´æ¥ä½¿ç”¨ç¼“å­˜ç‰ˆæœ¬æ›¿æ¢åŸç‰ˆ
functions:
  - get_weather_cached
```

#### æ–¹æ¡ˆBï¼šå¹¶è¡Œè¿è¡Œ
```yaml
# åŒæ—¶æä¾›ä¸¤ä¸ªç‰ˆæœ¬ï¼Œç”¨æˆ·å¯é€‰æ‹©
functions:
  - get_weather          # åŸç‰ˆ
  - get_weather_cached   # ç¼“å­˜ç‰ˆæœ¬
```

## ğŸ“ˆ ç›‘æ§å’Œè°ƒä¼˜

### ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§

```python
# åœ¨è°ƒè¯•æ¨¡å¼ä¸‹æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
from core.utils.weather_cache import get_weather_cache_pool

cache_pool = get_weather_cache_pool()
stats = cache_pool.get_stats()

print(f"å¤©æ°”ç¼“å­˜å‘½ä¸­ç‡: {stats['weather_cache']['hit_rate']:.2%}")
print(f"åŸå¸‚ç¼“å­˜å‘½ä¸­ç‡: {stats['city_cache']['hit_rate']:.2%}")
```

### æ€§èƒ½è°ƒä¼˜å»ºè®®

#### ç¼“å­˜æ—¶é—´ä¼˜åŒ–
```yaml
weather_cache:
  # é«˜é¢‘æŸ¥è¯¢åœºæ™¯
  weather_cache_ttl: 1800  # 30åˆ†é’Ÿ

  # ä½é¢‘æŸ¥è¯¢åœºæ™¯
  weather_cache_ttl: 7200  # 2å°æ—¶

  # å¯¹å®æ—¶æ€§è¦æ±‚é«˜
  weather_cache_ttl: 900   # 15åˆ†é’Ÿ
```

#### ç¼“å­˜å¤§å°ä¼˜åŒ–
```yaml
weather_cache:
  # å•ç”¨æˆ·/å°å›¢é˜Ÿ
  max_cache_size: 20

  # å¤šç”¨æˆ·/ä¼ä¸šç¯å¢ƒ
  max_cache_size: 100

  # å¤§å‹éƒ¨ç½²
  max_cache_size: 200
```

## ğŸ”§ é«˜çº§åŠŸèƒ½

### 1. å¼ºåˆ¶åˆ·æ–°

ç”¨æˆ·å¯ä»¥é€šè¿‡ç‰¹æ®ŠæŒ‡ä»¤å¼ºåˆ¶è·å–æœ€æ–°æ•°æ®ï¼š

```
ç”¨æˆ·ï¼š"å¼ºåˆ¶åˆ·æ–°åŒ—äº¬å¤©æ°”"
ç³»ç»Ÿï¼šè°ƒç”¨ get_weather_cached(location="åŒ—äº¬", force_refresh=True)
```

### 2. ç¼“å­˜é¢„çƒ­

```python
# ç³»ç»Ÿå¯åŠ¨æ—¶é¢„çƒ­å¸¸ç”¨åŸå¸‚ç¼“å­˜
common_cities = ["åŒ—äº¬", "ä¸Šæµ·", "å¹¿å·", "æ·±åœ³"]
for city in common_cities:
    get_weather_cached(conn, location=city)
```

### 3. å®šæ—¶æ¸…ç†

```python
import threading
import time

def cache_cleanup_task():
    while True:
        cache_pool = get_weather_cache_pool()
        cache_pool.clean_expired()
        time.sleep(1800)  # æ¯30åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡

# å¯åŠ¨åå°æ¸…ç†ä»»åŠ¡
cleanup_thread = threading.Thread(target=cache_cleanup_task, daemon=True)
cleanup_thread.start()
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®å®æ—¶æ€§

- **é€‚ç”¨åœºæ™¯**ï¼šå¤©æ°”æŸ¥è¯¢ã€å†å²æ•°æ®ã€ç›¸å¯¹ç¨³å®šçš„ä¿¡æ¯
- **ä¸é€‚ç”¨åœºæ™¯**ï¼šå®æ—¶ç¾å®³é¢„è­¦ã€åˆ†é’Ÿçº§æ°”è±¡å˜åŒ–

### 2. å†…å­˜ç®¡ç†

- å®šæœŸç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
- åˆç†è®¾ç½® `max_cache_size`
- è€ƒè™‘ä½¿ç”¨Redisç­‰å¤–éƒ¨ç¼“å­˜ï¼ˆå¯æ‰©å±•ï¼‰

### 3. é”™è¯¯å¤„ç†

- ç¼“å­˜å¤±æ•ˆæ—¶è‡ªåŠ¨é™çº§åˆ°APIè°ƒç”¨
- ç½‘ç»œå¼‚å¸¸æ—¶è¿”å›å‹å¥½é”™è¯¯ä¿¡æ¯
- è®°å½•å¼‚å¸¸æ—¥å¿—ä¾¿äºé—®é¢˜æ’æŸ¥

## ğŸ¯ æœ€ä½³å®è·µ

### 1. é…ç½®æ¨è

```yaml
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
plugins:
  weather_cache:
    weather_cache_ttl: 3600      # 1å°æ—¶å¹³è¡¡å®æ—¶æ€§å’Œæ€§èƒ½
    city_cache_ttl: 86400        # 24å°æ—¶ï¼ŒåŸå¸‚ä¿¡æ¯å¾ˆå°‘å˜åŒ–
    max_cache_size: 50           # é€‚ä¸­çš„ç¼“å­˜å¤§å°
    enable_async_refresh: true   # æå‡ç”¨æˆ·ä½“éªŒ
    cleanup_interval: 1800       # 30åˆ†é’Ÿæ¸…ç†è¿‡æœŸæ•°æ®
```

### 2. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

```python
# åœ¨è¿”å›ç»“æœä¸­æ˜¾ç¤ºæ•°æ®æ¥æº
weather_report = f"ğŸ“‹ [ç¼“å­˜æ•°æ®] æ‚¨æŸ¥è¯¢çš„ä½ç½®æ˜¯ï¼š{city_name}"
# æˆ–
weather_report = f"ğŸŒ [å®æ—¶æ•°æ®] æ‚¨æŸ¥è¯¢çš„ä½ç½®æ˜¯ï¼š{city_name}"
```

### 3. ç›‘æ§å’Œå‘Šè­¦

```python
# ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡ï¼Œä½äºé˜ˆå€¼æ—¶å‘Šè­¦
def monitor_cache_performance():
    stats = cache_pool.get_stats()
    hit_rate = stats['weather_cache']['hit_rate']
    
    if hit_rate < 0.5:  # å‘½ä¸­ç‡ä½äº50%
        logger.warning(f"å¤©æ°”ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½: {hit_rate:.2%}")
```

## ğŸ”„ å‡çº§è·¯å¾„

### Phase 1: æµ‹è¯•éƒ¨ç½²
1. åœ¨æµ‹è¯•ç¯å¢ƒéƒ¨ç½²ç¼“å­˜ç‰ˆæœ¬
2. éªŒè¯åŠŸèƒ½æ­£ç¡®æ€§
3. ç›‘æ§æ€§èƒ½æŒ‡æ ‡

### Phase 2: ç°åº¦å‘å¸ƒ
1. éƒ¨åˆ†ç”¨æˆ·ä½¿ç”¨ç¼“å­˜ç‰ˆæœ¬
2. æ”¶é›†ç”¨æˆ·åé¦ˆ
3. è°ƒä¼˜é…ç½®å‚æ•°

### Phase 3: å…¨é‡ä¸Šçº¿
1. å…¨éƒ¨åˆ‡æ¢åˆ°ç¼“å­˜ç‰ˆæœ¬
2. åˆ é™¤åŸç‰ˆä»£ç 
3. æŒç»­ç›‘æ§ä¼˜åŒ–

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ï¼š

1. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ä¸­çš„é”™è¯¯ä¿¡æ¯
2. éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®
3. ç¡®è®¤ç½‘ç»œè¿æ¥å’ŒAPIå¯†é’¥æœ‰æ•ˆæ€§
4. æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯å®šä½é—®é¢˜

---

**ç»“è®ºï¼šåœ¨IoTå’Œå¤šç”¨æˆ·ç¯å¢ƒä¸‹ï¼Œå¤©æ°”ç¼“å­˜æ± ï¼ˆå¹»å½±æ± ï¼‰æ˜¯ä¸€ä¸ªå¿…è¦ä¸”é«˜æ•ˆçš„ä¼˜åŒ–æ–¹æ¡ˆï¼Œå¯ä»¥æ˜¾è‘—æå‡ç³»ç»Ÿæ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚** 
# 📹 ONVIF摄像头控制插件使用指南

## 🎯 功能概述

ONVIF摄像头控制插件支持通过语音指令控制局域网内的ONVIF协议摄像头，实现以下功能：

### ✨ 主要特性
- 🎛️ **云台控制**：上下左右移动、缩放控制
- 📸 **抓拍功能**：即时抓拍并保存图像
- 🔄 **巡视功能**：自动360度查看四周
- 📍 **预设位置**：支持自定义预设位置
- 🗣️ **语音控制**：自然语言指令识别

## 🔧 配置步骤

### 1. 安装依赖包

```bash
pip install onvif-zeep==0.2.12 zeep==4.2.1 Pillow>=9.0.0
```

### 2. 摄像头配置

在 `main/xiaozhi-server/data/.config.yaml` 文件中添加摄像头配置：

```yaml
plugins:
  onvif_camera:
    # 摄像头连接配置
    cameras:
      bedroom_camera:  # 配置ID（内部使用）
        alias: "卧室摄像头"           # 语音识别的别名
        ip: "192.168.1.100"         # 摄像头IP地址
        port: 80                    # ONVIF端口（通常80或8080）
        username: "admin"           # 摄像头用户名
        password: "your_password"   # 摄像头密码
        profile_token: "Profile_1"  # 配置文件token（可选）
      
      living_room_camera:  # 可配置多个摄像头
        alias: "客厅摄像头"
        ip: "192.168.1.101"
        port: 80
        username: "admin"
        password: "your_password"
        profile_token: "Profile_1"
    
    # 抓拍图像存储配置
    capture_storage:
      local_path: "./captures"     # 图像保存路径
      max_files: 100              # 最大文件数量
      retention_days: 30          # 文件保留天数
    
    # 云台控制参数
    ptz_settings:
      move_speed: 0.5             # 移动速度（0.0-1.0）
      zoom_speed: 0.3             # 缩放速度（0.0-1.0）
      # 预设位置（可选）
      preset_positions:
        - name: "正前方"
          pan: 0                  # 水平角度
          tilt: 0                 # 垂直角度
          zoom: 0                 # 缩放级别
        - name: "门口"
          pan: 45
          tilt: -10
          zoom: 0.2
```

### 3. 插件启用

ONVIF摄像头控制插件会自动加载，无需手动配置启用。插件会在系统启动时自动注册到函数列表中。

## 🎤 语音指令示例

### 云台控制
- **基础移动**：
  - "让卧室摄像头向上一点"
  - "卧室摄像头往左转"
  - "客厅摄像头向下看"
  - "摄像头往右移动"

- **巡视功能**：
  - "帮我看看卧室的四周"
  - "让客厅摄像头巡视一下"
  - "卧室摄像头转一圈看看"

- **缩放控制**：
  - "摄像头放大一点"
  - "卧室摄像头拉近看看"
  - "缩小一些"

- **停止控制**：
  - "摄像头停止移动"
  - "停止转动"

### 抓拍功能
- **即时抓拍**：
  - "抓拍一张卧室的照片"
  - "给客厅拍个照"
  - "保存当前画面"
  - "拍张卧室的照片"

### 预设位置
- **移动到预设位置**：
  - "卧室摄像头回到正前方"
  - "摄像头看向门口"
  - "转到窗户位置"

## 🔍 摄像头发现与配置

### 查找摄像头IP地址

1. **使用路由器管理界面**：
   - 登录路由器管理页面
   - 查看已连接设备列表
   - 找到摄像头设备的IP地址

2. **使用IP扫描工具**：
   ```bash
   # 使用nmap扫描局域网
   nmap -sP 192.168.1.0/24
   
   # 或使用arp命令
   arp -a
   ```

3. **摄像头配置工具**：
   - 使用厂商提供的配置软件
   - 通过ONVIF Device Manager查找

### ONVIF端口确认

常见ONVIF端口：
- **80**：大多数摄像头的默认端口
- **8080**：备用HTTP端口
- **8999**：某些品牌的ONVIF端口

### 获取用户名密码

- 查看摄像头标签或说明书
- 常见默认账户：
  - admin/admin
  - admin/password
  - admin/123456
  - root/root

## 🛠️ 故障排除

### 常见问题

1. **摄像头连接失败**
   ```
   摄像头 卧室摄像头 连接失败: [Errno 111] Connection refused
   ```
   **解决方案**：
   - 确认IP地址和端口正确
   - 检查网络连通性：`ping 192.168.1.100`
   - 确认摄像头支持ONVIF协议

2. **认证失败**
   ```
   摄像头连接失败: 401 Unauthorized
   ```
   **解决方案**：
   - 确认用户名密码正确
   - 检查摄像头用户权限设置

3. **云台控制无响应**
   ```
   云台移动失败: PTZ服务不可用
   ```
   **解决方案**：
   - 确认摄像头支持云台控制
   - 检查摄像头云台设置是否启用

4. **抓拍失败**
   ```
   抓拍失败: HTTP状态码: 404
   ```
   **解决方案**：
   - 确认摄像头支持快照功能
   - 检查profile_token配置

### 调试技巧

1. **查看详细日志**：
   ```yaml
   log:
     log_level: DEBUG  # 在.config.yaml中设置
   ```

2. **测试ONVIF连接**：
   ```python
   # 创建测试脚本 test_onvif.py
   from onvif import ONVIFCamera
   
   camera = ONVIFCamera('192.168.1.100', 80, 'admin', 'password')
   profiles = camera.create_media_service().GetProfiles()
   print(f"找到 {len(profiles)} 个配置文件")
   ```

3. **网络连通性测试**：
   ```bash
   # 测试摄像头网络连接
   curl -I http://192.168.1.100:80
   ```

## 📁 文件结构

```
xiaozhi-server/
├── plugins_func/functions/
│   └── onvif_camera_control.py     # 主插件文件
├── data/
│   └── .config.yaml                # 配置文件
├── captures/                       # 抓拍图像存储目录（自动创建）
├── docs/
│   └── ONVIF_CAMERA_SETUP.md      # 本说明文档
└── requirements.txt                # 依赖包列表
```

## 🔐 安全建议

1. **密码安全**：
   - 使用强密码
   - 定期更换摄像头密码
   - 避免使用默认密码

2. **网络安全**：
   - 确保摄像头在内网环境
   - 不要将摄像头直接暴露到公网
   - 使用VPN访问远程摄像头

3. **数据保护**：
   - 定期清理抓拍图像
   - 设置合适的文件保留策略
   - 备份重要图像数据

## 📈 扩展功能

### 未来可能的功能扩展

1. **智能分析**：
   - 结合视觉大模型分析抓拍内容
   - 人脸识别和物体检测
   - 异常行为检测

2. **自动化功能**：
   - 定时抓拍
   - 运动检测触发录制
   - 智能巡视路径

3. **多设备协作**：
   - 多摄像头联动
   - 全景拼接
   - 智能切换

## 💡 使用技巧

1. **合理设置移动速度**：
   - 较慢的速度（0.3-0.5）适合精确定位
   - 较快的速度（0.7-1.0）适合快速巡视

2. **预设位置规划**：
   - 根据实际需求设置常用位置
   - 命名要简洁易记
   - 角度设置要考虑实际可视范围

3. **存储管理**：
   - 定期清理不需要的图像
   - 根据存储空间调整保留策略
   - 重要图像及时备份

## 🆘 获取支持

如果遇到问题，可以：

1. 查看系统日志获取详细错误信息
2. 检查摄像头厂商文档确认ONVIF支持
3. 在项目Issues中提交问题报告
4. 参考ONVIF官方文档：https://www.onvif.org/

---

**提示**：首次使用时建议先配置一个摄像头进行测试，确认功能正常后再添加更多摄像头。 